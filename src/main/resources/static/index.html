<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 600px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px #ccc;
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin: 10px 0;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .user {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border-bottom-right-radius: 0;
        }

        .bot {
            align-self: flex-start;
            background: #f1f1f1;
            color: #333;
            border-bottom-left-radius: 0;
        }

        #input-form {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        #user-input, #file-input {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>

<div id="chat-container">
    <div id="messages"></div>

    <form id="input-form" enctype="multipart/form-data">
        <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." />
        <input type="file" id="file-input" />
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>

<script>
    const form = document.getElementById('input-form');
    const input = document.getElementById('user-input');
    const fileInput = document.getElementById('file-input');
    const messages = document.getElementById('messages');

    let chatId = localStorage.getItem("chatId");
    if (!chatId) {
        chatId = crypto.randomUUID();
        localStorage.setItem("chatId", chatId);
    }

    let applicationId = null;

    // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞"
    const newButton = document.createElement("button");
    newButton.textContent = "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ (—É–¥–∞–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é)";
    newButton.type = "button";
    newButton.style.margin = "20px auto";
    newButton.style.display = "block";
    newButton.style.padding = "10px 20px";
    newButton.style.border = "none";
    newButton.style.background = "#007bff";
    newButton.style.color = "white";
    newButton.style.borderRadius = "20px";
    newButton.style.cursor = "pointer";

    newButton.onclick = async () => {
        applicationId = crypto.randomUUID();
        localStorage.setItem("applicationId", applicationId);

        appendMessage("üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + applicationId, "bot");
        appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", "bot");
        awaitingUsername = true;

        await fetch("/clear-dto", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                chatId: chatId,
                applicationId: applicationId
            })
        });

        updateSendButtonState();
    };

    const chatContainer = document.getElementById("chat-container");
    chatContainer.insertBefore(newButton, chatContainer.firstChild);

    // –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é"
    const sendButton = document.createElement("button");
    sendButton.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é";
    sendButton.type = "button";
    sendButton.disabled = true;
    sendButton.style.marginTop = "10px";
    sendButton.style.padding = "10px 20px";
    sendButton.style.border = "none";
    sendButton.style.background = "#007bff";
    sendButton.style.color = "white";
    sendButton.style.borderRadius = "20px";
    sendButton.style.cursor = "pointer";

    sendButton.onclick = async () => {
        const res = await fetch("/finalize", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                chatId: chatId,
                applicationId: applicationId
            })
        });

        if (res.ok) {
            appendMessage("‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é", "bot");
            applicationId = null;
            localStorage.removeItem("applicationId");
            updateSendButtonState();
        } else {
            appendMessage("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É", "bot");
        }
    };

    form.append(sendButton);

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userText = input.value.trim();
        const file = fileInput.files[0];

        if (!applicationId) {
            appendMessage("‚ùó –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞'", "bot");
            return;
        }

        if (!userText && !file) return;

        if (userText) appendMessage(userText, 'user');
        if (file) appendMessage("üìé –§–∞–π–ª: " + file.name, 'user');

        let usernameJustSet = false;

        // üîπ –°–Ω–∞—á–∞–ª–∞ ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–º—è
        if (awaitingUsername && userText) {
            awaitingUsername = false;
            usernameJustSet = true;

            await fetch("/set-username", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    applicationId: applicationId,
                    username: userText
                })
            });

            appendMessage("–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", "bot");
            appendMessage("–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ:<br>" +
                "‚Äì –ü–æ–ª—É—á–∞—Ç–µ–ª—è (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ò–ù–ù, –µ—Å–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–æ–≤—ã–π)<br>" +
                "‚Äì –°—Ç–∞—Ç—å—é –î–î–°<br>" +
                "‚Äì –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–æ—á—Ç–∞)<br>" +
                "‚Äì –î–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞<br>" +
                "‚Äì –î–∞—Ç—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–ø—Ä–∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏–ª–∏ —É—Å–ª—É–≥–∞—Ö)<br>" +
                "‚Äì –ü—Ä–∏–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª", "bot");

            updateSendButtonState();
        }

        // üîπ –î–∞–ª–µ–µ ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª –ò–õ–ò —Ç–µ–∫—Å—Ç (–∏ –∏–º—è —É–∂–µ –≤–≤–µ–¥–µ–Ω–æ)
        const isComment = userText.startsWith("#–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
        if (file || (!usernameJustSet && userText)) {
            const formData = new FormData();
            formData.append("chatId", chatId);
            formData.append("applicationId", applicationId);

            if (isComment) {
                // –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GigaChat, —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                await fetch("/add-comment", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                        applicationId: applicationId,
                        comment: userText
                    })
                });

                appendMessage("üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞—è–≤–∫—É", "bot");
                formData.append("message", ""); // –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ò–ò
            } else {
                formData.append("message", (!usernameJustSet ? userText : ""));
            }

            if (file) formData.append("file", file);

            try {
                const res = await fetch("/process", {
                    method: "POST",
                    body: formData
                });

                if (res.status === 413) {
                    appendMessage("‚ö† –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 20MB.", "bot");
                    return;
                }

                const replyText = await res.text();

                if (replyText && replyText.includes("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è")) {
                    appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", "bot");
                    awaitingUsername = true;
                }

                await showDtoSummary();
                updateSendButtonState();

            } catch (error) {
                appendMessage("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞", 'bot');
                console.error(error);
            }
        }

        input.value = '';
        fileInput.value = '';
    });

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message', sender);
        div.innerHTML = text.replace(/\n/g, "<br>");
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    async function showDtoSummary() {
        if (!applicationId) return;

        try {
            const res = await fetch("/get-dto?" + new URLSearchParams({
                chatId: chatId,
                applicationId: applicationId
            }));

            if (!res.ok) {
                appendMessage("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏", "bot");
                return;
            }

            const dto = await res.json();

            const fields = [
                ["–ü–æ–ª—É—á–∞—Ç–µ–ª—å", dto["receiver"] || dto["–ø–æ–ª—É—á–∞—Ç–µ–ª—å"]],
                ["–°—Ç–∞—Ç—å—è –î–î–°", dto["dds"] || dto["—Å—Ç–∞—Ç—å—è_–¥–¥—Å"]],
                ["–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ", dto["contact"] || dto["–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ"]],
                ["–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞", dto["paymentDate"] || dto["–¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞"]],
                ["–§–∞–π–ª", dto["file"] || dto["—Ñ–∞–π–ª"]],
                ["–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è", dto["deliveryDate"] || dto["–¥–∞—Ç–∞_–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è"]]
            ];

            const lines = fields.map(([label, value]) => `${label}: ${value?.trim() || "‚Äî"}`);
            appendMessage(lines.join("<br>"), "bot");

            const missing = fields.slice(0, 5)
                .filter(([_, value]) => !value || value.trim() === "")
                .map(f => f[0]);

            if (missing.length > 0) {
                appendMessage("‚ö† –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ: " + missing.join(", "), "bot");
            }
            if (missing.length === 0) {
                appendCommentPrompt();
            }

        } catch (e) {
            appendMessage("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏", "bot");
            console.error(e);
        }
    }
    function appendCommentPrompt() {
        const div = document.createElement('div');
        div.classList.add('message', 'bot');

        const text = document.createElement('div');
        text.innerHTML = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞—è–≤–∫—É. –ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é¬ª.<br>" +
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏ –Ω–∞ —á—Ç–æ.<br>" +
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:";

        const btn = document.createElement('button');
        btn.textContent = "‚úè –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
        btn.style.marginTop = "10px";
        btn.style.padding = "8px 16px";
        btn.style.borderRadius = "16px";
        btn.style.border = "none";
        btn.style.background = "#ffc107";
        btn.style.color = "#000";
        btn.style.cursor = "pointer";

        btn.onclick = () => {
            input.value = "#–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ";
            input.focus();
        };

        div.appendChild(text);
        div.appendChild(btn);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    async function updateSendButtonState() {
        if (!applicationId) {
            sendButton.disabled = true;
            return;
        }

        try {
            const res = await fetch("/check-dto?" + new URLSearchParams({
                chatId: chatId,
                applicationId: applicationId
            }));
            const isReady = await res.text();
            sendButton.disabled = (isReady !== "OK");
        } catch (e) {
            sendButton.disabled = true;
        }
    }

    updateSendButtonState();
</script>

</body>
</html>