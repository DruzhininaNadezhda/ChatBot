<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ß–∞—Ç —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 90vh;
            width: 90%;
            max-width: 600px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px #ccc;
            overflow: hidden;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
        #top-toolbar {
            display: flex;
            justify-content: flex-start;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            background: #fff;
            z-index: 1;
        }
        .btn-compact {
            font-size: 14px;
            padding: 6px 12px !important;
            border-radius: 14px !important;
            white-space: nowrap;
            border: none;
            color: #fff;
            cursor: pointer;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 5px 5px 5px 5px;
        }

        .message {
            margin: 10px 0;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        .user {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border-bottom-right-radius: 0;
            margin-left: auto;
            margin-right: 0;
        }
        .bot {
            align-self: flex-start;
            background: #f1f1f1;
            color: #333;
            border-bottom-left-radius: 0;
            margin-left: 0;
            margin-right: auto;
        }

        #input-form {
            display: flex;
            flex-direction: column;
            padding: 10px 15px 15px;
            border-top: 1px solid #ddd;
            gap: 8px;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }
        .input-row input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
        }
        .input-row button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }
        .input-row button:hover { background: #0056b3; }

        #user-input, #file-input {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
        }

        /*!* –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª ‚Äî –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É, —Å–∞–º–æ –ø–æ–ª–µ —É–∑–∫–æ–µ *!*/
        /*#file-input.narrow-file {*/
        /*    display: block;*/
        /*    width: 100%;         !* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É *!*/
        /*}*/

        /*#file-input.narrow-file::-webkit-file-upload-button {*/
        /*    width: auto;         !* —Å–∞–º–∞ –∫–Ω–æ–ø–∫–∞ —É–∑–∫–∞—è *!*/
        /*    padding: 6px 12px;*/
        /*}*/

        /*#file-input.narrow-file::file-selector-button {*/
        /*    width: auto;*/
        /*    padding: 6px 12px;*/
        /*}*/
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        #file-input.narrow-file {
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 6px 10px; /* —á—É—Ç—å –º–µ–Ω—å—à–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥—Ä–æ–º–æ–∑–¥–∫–æ */
        }

        /* –°–∞–º–∞ –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî —É–∑–∫–∞—è */
        #file-input.narrow-file::-webkit-file-upload-button {
            padding: 6px 12px;
            width: auto;
            background: #e9ecef;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            margin-right: 8px; /* –æ—Ç—Å—Ç—É–ø –æ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ */
        }

        #file-input.narrow-file::file-selector-button {
            padding: 6px 12px;
            width: auto;
            background: #e9ecef;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            margin-right: 8px;
        }

        /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî —É–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç –∏ –æ—Ç—Å—Ç—É–ø—ã */
        @media (max-width: 768px) {
            #file-input.narrow-file {
                font-size: 13px;
                padding: 4px 8px;
            }
            #file-input.narrow-file::-webkit-file-upload-button,
            #file-input.narrow-file::file-selector-button {
                font-size: 13px;
                padding: 4px 8px;
            }
        }


        button { cursor: pointer; }
        button:hover { opacity: .95; }

        @media (max-width: 768px) {
            #chat-container {
                width: 100vw;
                height: 100vh;
                max-width: none;
                border-radius: 0;
                box-shadow: none;
            }
            #messages { padding: 10px; }
            #input-form { padding: 10px; }
            #user-input { font-size: 18px; padding: 12px; }
            #file-input { font-size: 16px; }
            button, #send-button { font-size: 16px; padding: 8px 12px; }
        }
        /* === –®–∏—Ä–∏–Ω—ã –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ === */
        #top-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
            background: #fff;
        }
        #btn-new {
            flex: 2 1 0;         /* –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ = 2/3 */
        }
        #btn-checkmail {
            flex: 1 1 0;         /* –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É = 1/3 */
        }

        /* –ö–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é" ‚Äî –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É —á–∞—Ç–∞ */
        #btn-send {
            width: 100%;
            justify-content: center;
        }

        /* –î–æ–ø. –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å */
        .btn-compact {
            font-size: 14px;
            padding: 6px 12px !important;
            border-radius: 14px !important;
            white-space: nowrap;
        }

        /* === –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è === */
        @media (max-width: 768px) {
            #top-toolbar { gap: 6px; padding: 6px 8px; }
            .btn-compact { font-size: 13px; padding: 5px 10px !important; }
            #btn-send { font-size: 14px; padding: 8px 12px !important; }
            #file-input.narrow-file { max-width: 220px; }
        }
        /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî —É–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç –∏ –æ—Ç—Å—Ç—É–ø—ã */
        @media (max-width: 768px) {
            #file-input.narrow-file {
                font-size: 13px;
                padding: 4px 8px;
            }
            #file-input.narrow-file::-webkit-file-upload-button,
            #file-input.narrow-file::file-selector-button {
                font-size: 13px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>

<div id="chat-container">
    <!-- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="top-toolbar">
        <button id="btn-new" class="btn-compact" style="background:#ff5900;">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
        <button id="btn-checkmail" class="btn-compact" style="background:#0cab5e;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É</button>
    </div>

    <div id="messages"></div>

    <form id="input-form" enctype="multipart/form-data">
        <div class="input-row">
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." />
            <button type="submit" class="btn-compact">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        </div>
        <input type="file" id="file-input" class="narrow-file" />
        <button id="btn-send" type="button" class="btn-compact" style="align-self:flex-end;background:#007bff;">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é
        </button>
    </form>
</div>

<script>
    // === B24 AUTO START ===
    const urlParams = new URLSearchParams(location.search);
    let b24Token = urlParams.get('b24'); // –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å–∞, —Ç—É—Ç –±—É–¥–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π JWT
    // === /B24 AUTO START ===

    const form = document.getElementById('input-form');
    const input = document.getElementById('user-input');
    const fileInput = document.getElementById('file-input');
    const messages = document.getElementById('messages');

    const newButton = document.getElementById('btn-new');
    const checkMailButton = document.getElementById('btn-checkmail');
    const sendButton = document.getElementById('btn-send');

    let chatId = localStorage.getItem("chatId");
    if (!chatId) { chatId = crypto.randomUUID(); localStorage.setItem("chatId", chatId); }

    let applicationId = localStorage.getItem("applicationId") || null;
    let awaitingUsername = false;

    // "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞"
    newButton.onclick = async () => {
        applicationId = crypto.randomUUID();
        localStorage.setItem("applicationId", applicationId);

        appendMessage("üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: " + applicationId, "bot");

        if (b24Token) {
            try {
                const r = await fetch("/b24/new?" + new URLSearchParams({ applicationId, b24: b24Token }), { method: "POST" });
                if (r.ok) {
                    const head = await (await fetch('/dto-head?applicationId=' + encodeURIComponent(applicationId))).json();
                    const name = (head.username || "‚Äî").trim();
                    const mail = (head.userEmail || "‚Äî").trim();
                    appendMessage(`–ü—Ä–∏–≤–µ—Ç! –ü–æ—Ö–æ–∂–µ, –≤—ã ${name}, –∞ –≤–∞—à–∞ –ø–æ—á—Ç–∞ ‚Äî ${mail}.`, "bot");
                    awaitingUsername = !name;
                    history.replaceState(null, "", location.pathname);
                    b24Token = null;
                } else {
                    appendMessage("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–∏—Ç—Ä–∏–∫—Å. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤—Ä—É—á–Ω—É—é.", "bot");
                    appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è:", "bot");
                    awaitingUsername = true;
                }
            } catch {
                appendMessage("‚ö† –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤—Ä—É—á–Ω—É—é.", "bot");
                appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è:", "bot");
                awaitingUsername = true;
            }
        } else {
            appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è:", "bot");
            awaitingUsername = true;
        }

        updateSendButtonState();
    };

    // "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É"
    checkMailButton.onclick = async () => {
        if (!applicationId) { appendMessage("‚ùó –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞'", "bot"); return; }
        try {
            const res = await fetch("/mail/check", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ applicationId })
            });
            const data = await res.json();

            appendMessage(data.message, "bot");
            if (data.attachment) renderAttachment(data.attachment);

            await showDtoSummary();
            updateSendButtonState();
        } catch (e) {
            appendMessage("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ—á—Ç—ã: " + e.message, "bot");
        }
    };

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é
    sendButton.onclick = async () => {
        const res = await fetch("/finalize", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ chatId, applicationId })
        });
        if (res.ok) {
            appendMessage("‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é", "bot");
            applicationId = null;
            localStorage.removeItem("applicationId");
            updateSendButtonState();
        } else {
            appendMessage("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É", "bot");
        }
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π/—Ñ–∞–π–ª–∞
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userText = input.value.trim();
        const file = fileInput.files[0];

        if (!applicationId) { appendMessage("‚ùó –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ '–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞'", "bot"); return; }
        if (!userText && !file) return;

        if (userText) appendMessage(userText, 'user');
        if (file) appendMessage("üìé –§–∞–π–ª: " + file.name, 'user');

        let usernameJustSet = false;

        if (awaitingUsername && userText) {
            awaitingUsername = false;
            usernameJustSet = true;

            await fetch("/set-username", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ applicationId, username: userText })
            });

            appendMessage("–ò–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", "bot");
            appendMessage("–¢–µ–ø–µ—Ä—å, —É–∫–∞–∂–∏—Ç–µ –≤ —É–¥–æ–±–Ω–æ —Ñ–æ—Ä–º–∞—Ç–µ (–º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –±–µ–∑ —Å–ª–æ–≤ —É—Ç–æ—á–Ω–µ–Ω–∏–π):<br>" +
                "‚Äì –ü–æ–ª—É—á–∞—Ç–µ–ª—è (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ò–ù–ù, –µ—Å–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫ –Ω–æ–≤—ã–π)<br>" +
                "‚Äì –°—Ç–∞—Ç—å—é –î–î–°<br>" +
                "‚Äì –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–æ—á—Ç–∞)<br>" +
                "‚Äì –î–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞<br>" +
                "‚Äì –î–∞—Ç—É –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (–ø—Ä–∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏–ª–∏ —É—Å–ª—É–≥–∞—Ö)<br>" +
                "‚Äì –ü—Ä–∏–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª", "bot");

            updateSendButtonState();
        }

        const isComment = userText.startsWith("#–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:");
        if (file || (!usernameJustSet && userText)) {
            const formData = new FormData();
            formData.append("chatId", chatId);
            formData.append("applicationId", applicationId);

            if (isComment) {
                await fetch("/add-comment", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ applicationId, comment: userText })
                });
                appendMessage("üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞—è–≤–∫—É", "bot");
                formData.append("message", "");
            } else {
                formData.append("message", (!usernameJustSet ? userText : ""));
            }

            if (file) formData.append("file", file);

            try {
                const res = await fetch("/process", { method: "POST", body: formData });

                if (res.status === 413) {
                    appendMessage("‚ö† –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 20MB.", "bot");
                    return;
                }

                const replyText = await res.text();
                if (replyText && replyText.includes("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è")) {
                    appendMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:", "bot");
                    awaitingUsername = true;
                }

                await showDtoSummary();
                updateSendButtonState();
            } catch (error) {
                appendMessage("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞", 'bot');
                console.error(error);
            }
        }

        input.value = '';
        fileInput.value = '';
    });

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.classList.add('message', sender);
        div.innerHTML = text.replace(/\n/g, "<br>");
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    async function showDtoSummary() {
        if (!applicationId) return;
        try {
            const res = await fetch("/get-dto?" + new URLSearchParams({ chatId, applicationId }));
            if (!res.ok) { appendMessage("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏", "bot"); return; }

            const dto = await res.json();
            const fields = [
                ["–ü–æ–ª—É—á–∞—Ç–µ–ª—å", dto["receiver"] || dto["–ø–æ–ª—É—á–∞—Ç–µ–ª—å"]],
                ["–°—Ç–∞—Ç—å—è –î–î–°", dto["dds"] || dto["—Å—Ç–∞—Ç—å—è_–¥–¥—Å"]],
                ["–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ", dto["contact"] || dto["–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ"]],
                ["–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞", dto["paymentDate"] || dto["–¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞"]],
                ["–§–∞–π–ª", dto["file"] || dto["—Ñ–∞–π–ª"]],
                ["–î–∞—Ç–∞ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è", dto["deliveryDate"] || dto["–¥–∞—Ç–∞_–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è"]]
            ];
            const lines = fields.map(([label, value]) => `${label}: ${value?.toString().trim?.() ? value.trim() : "‚Äî"}`);
            appendMessage(lines.join("<br>"), "bot");

            const missing = fields.slice(0, 5)
                .filter(([_, value]) => !value || value.trim() === "")
                .map(f => f[0]);

            if (missing.length > 0) {
                appendMessage("‚ö† –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ: " + missing.join(", "), "bot");
            }
            if (missing.length === 0) {
                appendCommentPrompt();
            }

        } catch (e) {
            appendMessage("‚ö† –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏", "bot");
            console.error(e);
        }
    }
    function appendCommentPrompt() {
        const div = document.createElement('div');
        div.classList.add('message', 'bot');

        const text = document.createElement('div');
        text.innerHTML = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞—è–≤–∫—É. –ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é¬ª.<br>" +
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏ –Ω–∞ —á—Ç–æ.<br>" +
            "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:";

        const btn = document.createElement('button');
        btn.textContent = "‚úè –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π";
        btn.style.marginTop = "10px";
        btn.style.padding = "8px 16px";
        btn.style.borderRadius = "16px";
        btn.style.border = "none";
        btn.style.background = "#ffc107";
        btn.style.color = "#000";
        btn.style.cursor = "pointer";

        btn.onclick = () => {
            input.value = "#–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ";
            input.focus();
        };

        div.appendChild(text);
        div.appendChild(btn);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }
    function renderAttachment(att) {
        // att: { name, mimeType, size, url }
        const div = document.createElement('div');
        div.classList.add('message', 'bot');

        const a = document.createElement('a');
        a.href = att.url;                 // –æ—Ç–¥–∞—ë—Ç /mail/attachment/{token}
        a.textContent = `üìé ${att.name || '–í–ª–æ–∂–µ–Ω–∏–µ'} (${prettySize(att.size)})`;
        a.target = "_blank";
        a.download = att.name || '';      // –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏

        // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äì –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å"
        const btn = document.createElement('a');
        btn.href = att.url;
        btn.textContent = '–°–∫–∞—á–∞—Ç—å';
        btn.target = '_blank';
        btn.download = att.name || '';
        btn.style.marginLeft = '8px';

        div.appendChild(a);
        div.appendChild(btn);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    function prettySize(bytes) {
        if (bytes == null) return '‚Äî';
        const units = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë', '–¢–ë'];
        let i = 0, n = Number(bytes);
        while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
        return `${n.toFixed(n < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
    }

    async function updateSendButtonState() {
        if (!applicationId) {
            sendButton.disabled = true;
            return;
        }

        try {
            const res = await fetch("/check-dto?" + new URLSearchParams({
                chatId: chatId,
                applicationId: applicationId
            }));
            const isReady = await res.text();
            sendButton.disabled = (isReady !== "OK");
        } catch (e) {
            sendButton.disabled = true;
        }
    }

    updateSendButtonState();
</script>

</body>
</html>